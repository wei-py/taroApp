name: iOS Build & Deploy

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'æ„å»ºç±»å‹'
        required: true
        default: 'beta'
        type: choice
        options:
        - beta
        - release
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•'
        required: false
        default: false
        type: boolean

env:
  # åº”ç”¨é…ç½®
  APP_ID: ${{ secrets.APP_ID || 'com.bto.Light' }}
  APP_NAME: ${{ secrets.APP_NAME || 'BTOLIGHT' }}
  SCHEME_NAME: 'taroApp'
  
  # ç‰ˆæœ¬é…ç½®
  VERSION_NUMBER: ${{ secrets.VERSION_NUMBER || '2.9.0' }}
  BUILD_NUMBER: ${{ github.run_number }}
  
  # ç­¾åé…ç½®
  TEAM_ID: ${{ secrets.TEAM_ID }}
  PROVISIONING_PROFILE_SPECIFIER: ${{ secrets.PROVISIONING_PROFILE_SPECIFIER }}
  CODE_SIGN_IDENTITY: ${{ secrets.CODE_SIGN_IDENTITY || 'Apple Distribution' }}
  
  # è¯ä¹¦å’Œé…ç½®æ–‡ä»¶ (Base64ç¼–ç )
  SIGNING_CERTIFICATE_P12_DATA: ${{ secrets.SIGNING_CERTIFICATE_P12_DATA }}
  SIGNING_CERTIFICATE_PASSWORD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
  PROVISIONING_PROFILE_DATA: ${{ secrets.PROVISIONING_PROFILE_DATA }}
  
  # App Store Connect API
  APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
  APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
  APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
  
  # Fastlaneé…ç½®
  FASTLANE_SKIP_UPDATE_CHECK: true
  FASTLANE_HIDE_GITHUB_ISSUES: true
  FASTLANE_DISABLE_COLORS: true

jobs:
  build-ios:
    name: Build iOS App
    runs-on: macos-14
    timeout-minutes: 60
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ·ï¸ Get Version Info
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_release=true" >> $GITHUB_OUTPUT
        else
          echo "version=$VERSION_NUMBER" >> $GITHUB_OUTPUT
          echo "is_release=false" >> $GITHUB_OUTPUT
        fi
        echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
        
    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest
        
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        
    - name: ğŸ’ Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true
        working-directory: ios
        
    - name: ğŸ“± Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'
        
    - name: ğŸ”§ Install Dependencies
      run: |
        echo "ğŸ“¦ Installing Node.js dependencies..."
        pnpm install --frozen-lockfile
        
        echo "ğŸ’ Installing Ruby dependencies..."
        cd ios && bundle install
        
    - name: ğŸ—ï¸ Build Taro RN Bundle
      run: |
        echo "ğŸ—ï¸ Building Taro React Native bundle..."
        pnpm run build:rn
        
    - name: ğŸ Install CocoaPods Dependencies
      run: |
        cd ios
        echo "ğŸ Installing CocoaPods dependencies..."
        pod install --repo-update --clean-install
        
    - name: ğŸ” Setup Keychain
      run: |
        echo "ğŸ” Setting up build keychain..."
        KEYCHAIN_PASSWORD="${{ secrets.KEYCHAIN_PASSWORD || 'temp_keychain_password' }}"
        
        # åˆ›å»ºä¸´æ—¶keychain
        security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
        security set-keychain-settings -t 3600 -u build.keychain
        
    - name: ğŸ“œ Import Certificate
      run: |
        echo "ğŸ“œ Importing signing certificate..."
        if [ -z "$SIGNING_CERTIFICATE_P12_DATA" ]; then
          echo "âŒ SIGNING_CERTIFICATE_P12_DATA is not set"
          exit 1
        fi
        
        # è§£ç å¹¶å¯¼å…¥è¯ä¹¦
        echo "$SIGNING_CERTIFICATE_P12_DATA" | base64 --decode > certificate.p12
        security import certificate.p12 \
          -k build.keychain \
          -P "$SIGNING_CERTIFICATE_PASSWORD" \
          -T /usr/bin/codesign \
          -T /usr/bin/security
          
        # è®¾ç½®è¯ä¹¦è®¿é—®æƒé™
        security set-key-partition-list \
          -S apple-tool:,apple:,codesign: \
          -s -k "${{ secrets.KEYCHAIN_PASSWORD || 'temp_keychain_password' }}" \
          build.keychain
          
        # æ¸…ç†è¯ä¹¦æ–‡ä»¶
        rm certificate.p12
        
    - name: ğŸ“‹ Import Provisioning Profile
      run: |
        echo "ğŸ“‹ Importing provisioning profile..."
        if [ -z "$PROVISIONING_PROFILE_DATA" ]; then
          echo "âŒ PROVISIONING_PROFILE_DATA is not set"
          exit 1
        fi
        
        # åˆ›å»ºé…ç½®æ–‡ä»¶ç›®å½•
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        
        # è§£ç å¹¶ä¿å­˜é…ç½®æ–‡ä»¶
        echo "$PROVISIONING_PROFILE_DATA" | base64 --decode > profile.mobileprovision
        
        # è·å–é…ç½®æ–‡ä»¶UUID
        PROFILE_UUID=$(security cms -D -i profile.mobileprovision | plutil -extract UUID xml1 - -o - | sed -n 's/.*<string>\(.*\)<\/string>.*/\1/p')
        
        # å¤åˆ¶åˆ°æ­£ç¡®ä½ç½®
        cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$PROFILE_UUID.mobileprovision
        
        echo "âœ… Provisioning profile installed with UUID: $PROFILE_UUID"
        rm profile.mobileprovision
        
    - name: ğŸ”‘ Setup App Store Connect API Key
      run: |
        echo "ğŸ”‘ Setting up App Store Connect API key..."
        if [ -n "$APP_STORE_CONNECT_API_KEY_CONTENT" ]; then
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$APP_STORE_CONNECT_API_KEY_CONTENT" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8
          echo "âœ… App Store Connect API key configured"
        else
          echo "âš ï¸ App Store Connect API key not provided"
        fi
        
    - name: ğŸ§ª Run Tests
      if: ${{ !inputs.skip_tests }}
      run: |
        cd ios
        echo "ğŸ§ª Running iOS tests..."
        bundle exec fastlane test
        
    - name: ğŸš€ Build and Deploy
      run: |
        cd ios
        
        # ç¡®å®šæ„å»ºç±»å‹
        if [[ "${{ steps.version.outputs.is_release }}" == "true" ]] || [[ "${{ github.event.inputs.build_type }}" == "release" ]]; then
          echo "ğŸš€ Building for App Store release..."
          bundle exec fastlane release
        else
          echo "ğŸ§ª Building beta version..."
          bundle exec fastlane beta
        fi
      env:
        VERSION_NUMBER: ${{ steps.version.outputs.version }}
        BUILD_NUMBER: ${{ steps.version.outputs.build_number }}
        SKIP_GIT_CHECK: true
        CI: true
        
    - name: ğŸ“Š Upload Build Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ios-build-artifacts-${{ github.run_number }}
        path: |
          ios/build/
          ios/fastlane/report.xml
          ios/fastlane/test_output/
          ios/fastlane/screenshots/
          ios/gym/
        retention-days: 30
        
    - name: ğŸ“ Upload Logs
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: ios-build-logs-${{ github.run_number }}
        path: |
          ios/fastlane/logs/
          ~/Library/Logs/gym/
          ~/Library/Developer/Xcode/DerivedData/
        retention-days: 7
        
    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up..."
        
        # åˆ é™¤keychain
        security delete-keychain build.keychain || true
        
        # æ¸…ç†é…ç½®æ–‡ä»¶
        rm -rf ~/Library/MobileDevice/Provisioning\ Profiles/*.mobileprovision || true
        
        # æ¸…ç†APIå¯†é’¥
        rm -rf ~/.appstoreconnect/private_keys/AuthKey_*.p8 || true
        
        echo "âœ… Cleanup completed"
        
    - name: ğŸ“¢ Notify Success
      if: success()
      run: |
        echo "ğŸ‰ iOS build completed successfully!"
        echo "ğŸ“± App: $APP_NAME"
        echo "ğŸ·ï¸ Version: ${{ steps.version.outputs.version }}"
        echo "ğŸ”¢ Build: ${{ steps.version.outputs.build_number }}"
        
    - name: ğŸ“¢ Notify Failure
      if: failure()
      run: |
        echo "âŒ iOS build failed!"
        echo "ğŸ“± App: $APP_NAME"
        echo "ğŸ·ï¸ Version: ${{ steps.version.outputs.version }}"
        echo "ğŸ”¢ Build: ${{ steps.version.outputs.build_number }}"