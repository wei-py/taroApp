default_platform(:ios)

platform :ios do
  desc "构建并导出 iOS App"
  lane :build_ios_app do |options|
    # 从环境变量或参数读取
    app_identifier = ENV["APP_ID"] || options[:app_identifier]
    app_name = ENV["APP_NAME"] || options[:app_name]
    version = ENV["VERSION_NUMBER"] || options[:version]
    build_number = ENV["BUILD_NUMBER"] || options[:build_number]
    build_type = ENV["BUILD_TYPE"] || options[:build_type] || "Release"

    team_id = ENV["TEAM_ID"]
    provisioning_profile_specifier = ENV["PROVISIONING_PROFILE_SPECIFIER"]
    code_sign_identity = ENV["CODE_SIGN_IDENTITY"]

    # 修改 Bundle Identifier
    update_app_identifier(
      xcodeproj: "taroApp.xcodeproj",
      plist_path: "taroApp/Info.plist",
      app_identifier: app_identifier
    )

    # 修改 Bundle Display Name（APP_NAME）
    update_info_plist(
      xcodeproj: "taroApp.xcodeproj",
      plist_path: "taroApp/Info.plist",
      display_name: app_name
    )

    # 修改版本号
    increment_version_number(
      xcodeproj: "taroApp.xcodeproj",
      version_number: version
    )

    # 修改 Build Number
    increment_build_number(
      xcodeproj: "taroApp.xcodeproj",
      build_number: build_number
    )

    # 使用 gym 来构建和导出（避免和 lane 名称冲突）
    gym(
      workspace: "taroApp.xcworkspace",
      scheme: "taroApp",
      export_method: export_method_for(build_type),
      export_options: {
        provisioningProfiles: {
          app_identifier => provisioning_profile_specifier
        },
        signingStyle: "manual",
        teamID: team_id,
        signingCertificate: code_sign_identity
      },
      export_xcargs: "-allowProvisioningUpdates",
      clean: true
    )
  end

  desc "上传到 TestFlight"
  lane :upload_testflight do
    pilot(
      skip_waiting_for_build_processing: true,
      skip_submission: true
    )
  end

  private_lane :export_method_for do |build_type|
    case build_type.downcase
    when "appstore"
      "app-store"
    when "adhoc"
      "ad-hoc"
    when "development"
      "development"
    else
      "app-store"
    end
  end
end
