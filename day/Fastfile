default_platform(:ios)

platform :ios do
  desc "æ„å»ºå¹¶å¯¼å‡º iOS App"
  lane :ios_build do |options|
    # ä»ç¯å¢ƒå˜é‡æˆ–å‚æ•°è¯»å–
    app_identifier = ENV["APP_ID"] || options[:app_identifier]
    app_name = ENV["APP_NAME"] || options[:app_name]
    version = ENV["VERSION_NUMBER"] || options[:version]
    build_number = ENV["BUILD_NUMBER"] || options[:build_number]
    build_type = ENV["BUILD_TYPE"] || options[:build_type] || "Release"

    team_id = ENV["TEAM_ID"]
    provisioning_profile_specifier = ENV["PROVISIONING_PROFILE_SPECIFIER"]
    code_sign_identity = ENV["CODE_SIGN_IDENTITY"]

    # éªŒè¯å¿…è¦çš„ç¯å¢ƒå˜é‡
    if team_id.nil? || team_id.empty?
      UI.user_error!("TEAM_ID environment variable is required but not set")
    end
    
    if provisioning_profile_specifier.nil? || provisioning_profile_specifier.empty?
      UI.user_error!("PROVISIONING_PROFILE_SPECIFIER environment variable is required but not set")
    end

    UI.message("ğŸ”§ Build Configuration:")
    UI.message("   App ID: #{app_identifier}")
    UI.message("   App Name: #{app_name}")
    UI.message("   Version: #{version}")
    UI.message("   Build Number: #{build_number}")
    UI.message("   Team ID: #{team_id}")
    UI.message("   Provisioning Profile: #{provisioning_profile_specifier}")
    UI.message("   Code Sign Identity: #{code_sign_identity}")

    # ä¿®æ”¹ Bundle Identifier
    update_app_identifier(
      xcodeproj: "taroApp.xcodeproj",
      plist_path: "taroApp/Info.plist",
      app_identifier: app_identifier
    )

    # ä¿®æ”¹ Bundle Display Nameï¼ˆAPP_NAMEï¼‰
    update_info_plist(
      xcodeproj: "taroApp.xcodeproj",
      plist_path: "taroApp/Info.plist",
      display_name: app_name
    )

    # ä¿®æ”¹ç‰ˆæœ¬å·
    increment_version_number(
      xcodeproj: "taroApp.xcodeproj",
      version_number: version
    )

    # ä¿®æ”¹ Build Number
    increment_build_number(
      xcodeproj: "taroApp.xcodeproj",
      build_number: build_number
    )

    # è®¾ç½®ä»£ç ç­¾åé…ç½®
    update_code_signing_settings(
      use_automatic_signing: false,
      team_id: team_id,
      code_sign_identity: code_sign_identity,
      profile_name: provisioning_profile_specifier,
      path: "taroApp.xcodeproj"
    )

    # è·å–å¯¼å‡ºæ–¹æ³•
    export_method = export_method_for(build_type: build_type)
    
    # ä½¿ç”¨ gym æ¥æ„å»ºå’Œå¯¼å‡º
    gym(
      workspace: "taroApp.xcworkspace",
      scheme: "taroApp",
      export_method: export_method,
      output_directory: "./build",
      output_name: "taroApp",
      codesigning_identity: code_sign_identity,
      export_options: {
        "method" => export_method,
        "provisioningProfiles" => {
          app_identifier => provisioning_profile_specifier
        },
        "signingStyle" => "manual",
        "teamID" => team_id,
        "signingCertificate" => code_sign_identity
      },
      export_xcargs: "-allowProvisioningUpdates",
      clean: true
    )
    
    UI.success("âœ… Build completed successfully!")
    UI.message("ğŸ“¦ IPA file location: ./build/taroApp.ipa")
  end

  desc "ä¸Šä¼ åˆ° TestFlight"
  lane :testflight_upload do |options|
    # æ£€æŸ¥æ˜¯å¦æœ‰API Keyé…ç½®ï¼ˆæ¨èæ–¹å¼ï¼‰
    api_key_path = ENV["APP_STORE_CONNECT_API_KEY_PATH"]
    api_key_id = ENV["APP_STORE_CONNECT_API_KEY_ID"]
    api_issuer_id = ENV["APP_STORE_CONNECT_ISSUER_ID"]
    
    # æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·åé…ç½®ï¼ˆå¤‡ç”¨æ–¹å¼ï¼‰
    username = ENV["APP_STORE_CONNECT_USERNAME"]
    
    # æŸ¥æ‰¾IPAæ–‡ä»¶ - å…ˆæ£€æŸ¥buildç›®å½•ï¼Œå†æ£€æŸ¥å½“å‰ç›®å½•
    ipa_path = nil
    
    # æ£€æŸ¥buildç›®å½•
    if File.exist?("./build/taroApp.ipa")
      ipa_path = "./build/taroApp.ipa"
    else
      # æ£€æŸ¥å½“å‰ç›®å½•
      ipa_files = Dir.glob("*.ipa")
      ipa_path = ipa_files.first unless ipa_files.empty?
    end
    
    if ipa_path.nil?
      UI.user_error!("âŒ No IPA file found. Please run ios_build lane first.")
    end
    
    UI.message("ğŸ“¦ Found IPA file: #{ipa_path}")
    
    if api_key_path && api_key_id && api_issuer_id
      # å±•å¼€è·¯å¾„ä¸­çš„ ~ ç¬¦å·
      expanded_api_key_path = File.expand_path(api_key_path)
      
      # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      unless File.exist?(expanded_api_key_path)
        UI.user_error!("âŒ API Key file not found at path: #{expanded_api_key_path}")
      end
      
      # ä½¿ç”¨ API Key æ–¹å¼ï¼ˆæ¨èï¼‰
      UI.message("ğŸ”‘ Using App Store Connect API Key for authentication")
      UI.message("ğŸ“„ API Key path: #{expanded_api_key_path}")
      
      # åˆ›å»º API Key é…ç½®
      api_key = app_store_connect_api_key(
        key_id: api_key_id,
        issuer_id: api_issuer_id,
        key_filepath: expanded_api_key_path
      )
      
      pilot(
        api_key: api_key,
        ipa: ipa_path,
        skip_waiting_for_build_processing: true,
        skip_submission: true
      )
    elsif username
      # ä½¿ç”¨ç”¨æˆ·åæ–¹å¼ï¼ˆéœ€è¦åº”ç”¨ä¸“ç”¨å¯†ç ï¼‰
      UI.message("ğŸ‘¤ Using username for authentication")
      pilot(
        username: username,
        ipa: ipa_path,
        skip_waiting_for_build_processing: true,
        skip_submission: true
      )
    else
      # å°è¯•ä½¿ç”¨é»˜è®¤è®¤è¯
      UI.message("ğŸ” Using default authentication method")
      pilot(
        ipa: ipa_path,
        skip_waiting_for_build_processing: true,
        skip_submission: true
      )
    end
    
    UI.success("âœ… Upload to TestFlight completed successfully!")
  end

  # ç§æœ‰æ–¹æ³• - ä¿®å¤å‚æ•°æ ¼å¼
  private_lane :export_method_for do |options|
    build_type = options[:build_type]
    case build_type.downcase
    when "appstore"
      "app-store"
    when "adhoc"
      "ad-hoc"
    when "development"
      "development"
    else
      "app-store"
    end
  end
end
