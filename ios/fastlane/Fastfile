# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do
  # ç¯å¢ƒå˜é‡é…ç½®
  APP_ID = ENV["APP_ID"] || "com.bto.Light"
  APP_NAME = ENV["APP_NAME"] || "BTOLIGHT"
  VERSION_NUMBER = ENV["VERSION_NUMBER"] || "2.9.0"
  BUILD_NUMBER = ENV["BUILD_NUMBER"] || Time.now.strftime("%Y%m%d%H%M")
  BUILD_TYPE = ENV["BUILD_TYPE"] || "AppStore"
  TEAM_ID = ENV["TEAM_ID"]
  PROVISIONING_PROFILE_SPECIFIER = ENV["PROVISIONING_PROFILE_SPECIFIER"] || "BTOLIGHT"
  CODE_SIGN_IDENTITY = ENV["CODE_SIGN_IDENTITY"] || "Apple Distribution"
  
  # App Store Connect API é…ç½®
  API_KEY_ID = ENV["APP_STORE_CONNECT_API_KEY_ID"]
  ISSUER_ID = ENV["APP_STORE_CONNECT_ISSUER_ID"]
  
  before_all do
    # ç¡®ä¿å·¥ä½œç›®å½•æ­£ç¡®
    ensure_git_status_clean unless ENV["SKIP_GIT_CHECK"]
    
    # è®¾ç½® App Store Connect API Key
    if API_KEY_ID && ISSUER_ID
      app_store_connect_api_key(
        key_id: API_KEY_ID,
        issuer_id: ISSUER_ID,
        key_filepath: "~/.appstoreconnect/private_keys/AuthKey_#{API_KEY_ID}.p8",
        duration: 1200,
        in_house: false
      )
    end
  end

  desc "æ„å»ºå¹¶ä¸Šä¼ åˆ° App Store Connect"
  lane :release do
    # æ›´æ–°ç‰ˆæœ¬å·å’Œæ„å»ºå·
    update_version_and_build_number
    
    # æ„å»ºåº”ç”¨
    build_app_for_release
    
    # ä¸Šä¼ åˆ° App Store Connect
    upload_to_app_store_connect
    
    # å‘é€é€šçŸ¥
    send_notification("âœ… iOS åº”ç”¨å·²æˆåŠŸæ„å»ºå¹¶ä¸Šä¼ åˆ° App Store Connect")
  end

  desc "ä»…æ„å»ºåº”ç”¨ï¼ˆä¸ä¸Šä¼ ï¼‰"
  lane :build_only do
    update_version_and_build_number
    build_app_for_release
    send_notification("âœ… iOS åº”ç”¨æ„å»ºå®Œæˆ")
  end

  desc "æ„å»ºæµ‹è¯•ç‰ˆæœ¬"
  lane :beta do
    update_version_and_build_number
    
    # æ„å»º Ad Hoc ç‰ˆæœ¬ç”¨äºæµ‹è¯•
    build_app(
      scheme: "taroApp",
      configuration: "Release",
      export_method: "ad-hoc",
      export_options: {
        provisioningProfiles: {
          APP_ID => PROVISIONING_PROFILE_SPECIFIER
        },
        signingStyle: "manual",
        teamID: TEAM_ID
      },
      output_directory: "./build",
      output_name: "#{APP_NAME}_#{VERSION_NUMBER}_#{BUILD_NUMBER}_AdHoc.ipa"
    )
    
    send_notification("âœ… iOS æµ‹è¯•ç‰ˆæœ¬æ„å»ºå®Œæˆ")
  end

  desc "æ›´æ–°ç‰ˆæœ¬å·å’Œæ„å»ºå·"
  private_lane :update_version_and_build_number do
    # æ›´æ–°ç‰ˆæœ¬å·
    increment_version_number(
      version_number: VERSION_NUMBER,
      xcodeproj: "taroApp.xcodeproj"
    )
    
    # æ›´æ–°æ„å»ºå·
    increment_build_number(
      build_number: BUILD_NUMBER,
      xcodeproj: "taroApp.xcodeproj"
    )
    
    UI.success("ç‰ˆæœ¬å·å·²æ›´æ–°ä¸º: #{VERSION_NUMBER}")
    UI.success("æ„å»ºå·å·²æ›´æ–°ä¸º: #{BUILD_NUMBER}")
  end

  desc "æ„å»ºå‘å¸ƒç‰ˆæœ¬"
  private_lane :build_app_for_release do
    # æ¸…ç†ä¹‹å‰çš„æ„å»º
    clean_build_artifacts
    
    # æ„å»ºåº”ç”¨
    build_app(
      scheme: "taroApp",
      configuration: "Release",
      export_method: BUILD_TYPE.downcase,
      export_options: {
        provisioningProfiles: {
          APP_ID => PROVISIONING_PROFILE_SPECIFIER
        },
        signingStyle: "manual",
        teamID: TEAM_ID,
        compileBitcode: false,
        uploadBitcode: false,
        uploadSymbols: true,
        manageAppVersionAndBuildNumber: false
      },
      output_directory: "./build",
      output_name: "#{APP_NAME}_#{VERSION_NUMBER}_#{BUILD_NUMBER}.ipa",
      include_symbols: true,
      include_bitcode: false
    )
    
    UI.success("åº”ç”¨æ„å»ºå®Œæˆ: #{lane_context[SharedValues::IPA_OUTPUT_PATH]}")
  end

  desc "ä¸Šä¼ åˆ° App Store Connect"
  private_lane :upload_to_app_store_connect do
    begin
      upload_to_app_store(
        ipa: lane_context[SharedValues::IPA_OUTPUT_PATH],
        skip_screenshots: true,
        skip_metadata: true,
        skip_app_version_update: true,
        force: true,
        precheck_include_in_app_purchases: false,
        submit_for_review: false,
        automatic_release: false,
        platform: "ios"
      )
      
      UI.success("åº”ç”¨å·²æˆåŠŸä¸Šä¼ åˆ° App Store Connect")
    rescue => exception
      UI.error("ä¸Šä¼ å¤±è´¥: #{exception.message}")
      send_notification("âŒ iOS åº”ç”¨ä¸Šä¼ å¤±è´¥: #{exception.message}")
      raise exception
    end
  end

  desc "æ¸…ç†æ„å»ºäº§ç‰©"
  private_lane :clean_build_artifacts do
    # æ¸…ç† Xcode æ„å»ºç¼“å­˜
    clear_derived_data
    
    # æ¸…ç†ä¹‹å‰çš„æ„å»ºæ–‡ä»¶
    sh("rm -rf ../build") if File.exist?("../build")
    
    UI.success("æ„å»ºäº§ç‰©å·²æ¸…ç†")
  end

  desc "å‘é€é€šçŸ¥"
  private_lane :send_notification do |options|
    message = options[:message] || options
    
    # å¯ä»¥é›†æˆ Slackã€é’‰é’‰ç­‰é€šçŸ¥æœåŠ¡
    UI.important("ğŸ“± #{message}")
    
    # å¦‚æœé…ç½®äº† Slack Webhookï¼Œå¯ä»¥å‘é€åˆ° Slack
    if ENV["SLACK_WEBHOOK_URL"]
      slack(
        message: message,
        webhook_url: ENV["SLACK_WEBHOOK_URL"],
        channel: ENV["SLACK_CHANNEL"] || "#ios-builds",
        username: "Fastlane Bot",
        icon_emoji: ":rocket:"
      )
    end
  end

  # é”™è¯¯å¤„ç†
  error do |lane, exception|
    UI.error("Lane #{lane} æ‰§è¡Œå¤±è´¥")
    UI.error("é”™è¯¯ä¿¡æ¯: #{exception.message}")
    send_notification("âŒ Lane #{lane} æ‰§è¡Œå¤±è´¥: #{exception.message}")
  end

  # æ‰§è¡Œå®Œæˆåçš„æ¸…ç†å·¥ä½œ
  after_all do |lane|
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    clean_build_artifacts if ENV["CLEAN_AFTER_BUILD"] == "true"
    UI.success("Lane #{lane} æ‰§è¡Œå®Œæˆ")
  end
end